---
// Simple client-side course progress using localStorage
// Configure lessons list and mapping to pageIds used by ProgressTracker
const lessons: { id: string; path: string; title: string; hasQuiz: boolean }[] = [
  { id: 'ref-1', path: '/reference/1/', title: 'ما هي الوسائط المتعددة', hasQuiz: true },
  { id: 'ref-2', path: '/reference/2/', title: 'الروابط الفائقة والوسائط المتعددة', hasQuiz: true },
  { id: 'ref-3', path: '/reference/3/', title: 'الدرس الثالث', hasQuiz: false },
  { id: 'ref-4', path: '/reference/4/', title: 'الدرس الرابع', hasQuiz: false },
  { id: 'ref-5', path: '/reference/5/', title: 'الدرس الخامس', hasQuiz: false },
  { id: 'ref2-1', path: '/reference_2/1/', title: 'نماذج الألوان في الصور', hasQuiz: true },
  { id: 'ref2-2', path: '/reference_2/2/', title: 'نظام الألوان في الفيديو', hasQuiz: true },
  { id: 'ref2-3', path: '/reference_2/3/', title: 'تشكيل الصور في الكاميرات الرقمية', hasQuiz: true },
  { id: 'ref2-4', path: '/reference_2/4/', title: 'تشكيل الصور حاسوبيًا', hasQuiz: true },
  { id: 'ref2-5', path: '/reference_2/5/', title: 'أنواع الصور الرقمية', hasQuiz: true },
  { id: 'ref2-6', path: '/reference_2/6/', title: 'الأنماط الشائعة لملفات الصور', hasQuiz: true },
];
---
<style>
  .cp { border: 1px solid var(--sl-color-border); border-radius: 12px; padding: 1rem; background: color-mix(in srgb, var(--sl-color-border) 8%, transparent); }
  .row { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
  .bar { width: 100%; height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
  .fill { height: 100%; background: var(--sl-color-accent); width: 0%; transition: width .3s ease; }
  .muted { color: var(--sl-color-text-muted, #6b7280); font-size: .9rem; }
  .list { margin-top: .75rem; display: grid; gap: .5rem; }
  .item { display: flex; align-items: center; justify-content: space-between; gap: .5rem; padding: .5rem; border-radius: 6px; background: rgba(255,255,255,.05); }
  .item-left { display: flex; align-items: center; gap: .5rem; flex: 1; }
  .badge { padding: 0 .5rem; border-radius: 999px; font-size: .75rem; background: #9ca3af; color: white; white-space: nowrap; }
  .done { background: #16a34a; }
  .btn, .btn-small { background: var(--sl-color-accent); color: white; border: none; border-radius: 6px; padding: .5rem .75rem; text-decoration: none; display: inline-block; font-size: .85rem; cursor: pointer; width: 120px; }
  .btn:hover { opacity: .9; }
  .btn-continue { background: var(--sl-color-primary); color: white; border: none; border-radius: 6px; padding: .75rem 1.5rem; text-decoration: none; display: inline-block; font-size: .9rem; cursor: pointer; transition: background-color .3s ease; }
  .btn-continue:hover { background-color: var(--sl-color-muted-blue); }
</style>
<div class="cp" dir="rtl" id="course-progress">
  <div class="row" style="margin-bottom:.5rem">
    <strong>تقدّم الدورة</strong>
    <span class="muted" data-role="pct">0%</span>
  </div>
  <div class="bar"><div class="fill" data-role="fill"></div></div>
  <div class="row" style="margin-top:.75rem">
    <span class="muted">استمر من حيث توقفت</span>
    <a class="btn-continue" data-role="continue" href="/reference/1/">متابعة</a>
  </div>
  <div class="list">
    {lessons.map(l => (
      <div class="item">
        <div class="item-left">
          <span>{l.title}</span>
          <span class="badge" data-role={`b-${l.id}`}>غير مكتمل</span>
        </div>
        <button class="btn btn-small" data-role={`btn-${l.id}`} onclick={`completeLesson('${l.id}', ${l.hasQuiz})`}>
          {l.hasQuiz ? 'حل الاختبار' : 'إكمال'}
        </button>
      </div>
    ))}
  </div>
</div>
<script is:inline>
  const allLessons = [
    {id:'ref-1',path:'/reference/1/',hasQuiz:true},
    {id:'ref-2',path:'/reference/2/',hasQuiz:true},
    {id:'ref-3',path:'/reference/3/',hasQuiz:false},
    {id:'ref-4',path:'/reference/4/',hasQuiz:false},
    {id:'ref-5',path:'/reference/5/',hasQuiz:false},
    {id:'ref2-1',path:'/reference_2/1/',hasQuiz:true},
    {id:'ref2-2',path:'/reference_2/2/',hasQuiz:true},
    {id:'ref2-3',path:'/reference_2/3/',hasQuiz:true},
    {id:'ref2-4',path:'/reference_2/4/',hasQuiz:true},
    {id:'ref2-5',path:'/reference_2/5/',hasQuiz:true},
    {id:'ref2-6',path:'/reference_2/6/',hasQuiz:true}
  ];
  
  window.completeLesson = function(id, hasQuiz){
    if(hasQuiz){
      const path = allLessons.find(l => l.id === id)?.path;
      if(path) window.location.href = path;
    } else {
      try { localStorage.setItem('progress:'+id, '1'); } catch(e){}
      const badge = document.querySelector(`[data-role="b-${id}"]`);
      if(badge){ badge.textContent = 'مكتمل'; badge.classList.add('done'); }
      updateProgress();
    }
  };
  
  function updateProgress(){
    const getDone = (id) => localStorage.getItem('progress:'+id) === '1';
    let firstIncomplete = null; let completed = 0;
    for(const l of allLessons){
      const badge = document.querySelector(`[data-role="b-${l.id}"]`);
      const done = getDone(l.id);
      if(done){ completed++; if(badge){ badge.textContent='مكتمل'; badge.classList.add('done'); } }
      else if(!firstIncomplete){ firstIncomplete = l; }
    }
    const pct = allLessons.length ? Math.round((completed/allLessons.length)*100) : 0;
    const fill = document.querySelector('#course-progress [data-role="fill"]');
    const pctEl = document.querySelector('#course-progress [data-role="pct"]');
    if(fill) fill.style.width = pct + '%';
    if(pctEl) pctEl.textContent = pct + '%';
    const cont = document.querySelector('#course-progress [data-role="continue"]');
    if(cont){ cont.setAttribute('href', (firstIncomplete? firstIncomplete.path : allLessons[allLessons.length-1].path)); }
  }
  
  (function(){
    updateProgress();
    try {
      document.addEventListener('lesson-completed', function(){ updateProgress(); });
    } catch(e){}
  })();
</script>
